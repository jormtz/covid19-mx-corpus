---
title: "Corpus Covid19-MX"
output: html_notebook
---

Paquetes:

```{R}
library(tidyverse)
library(rvest)
library(selectr)
library(xml2)
```

Ahora cargamos las direcciones URL con las versiones estenográficas de los informes. Parece que no hubo conferencia el 7 o el 8 de marzo de 2020. Conferencias hasta el 20 de abril.

```{R}
url_conferencias <- c(readLines("urls_informes.txt"))
```

Funciones y directorio para el corpus...

```{R}
dame_fecha <- function(pagina){
#Obtiene la fecha del documento y la devuelve en formato YYYY-MM-DD
  fecha <- html_nodes(pagina, ".border-box") %>% 
  html_nodes("dd") %>% 
  html_text() %>% 
  paste0(collapse = " ") %>% 
  str_replace("Presidencia de la República  ", "") %>% 
  str_replace_all(" de ", " ") %>% 
  as.Date(format="%d %B %Y")
  return(fecha)
}

dame_texto <- function(pagina){
#Obtener texto de la conferencia
  texto <- html_nodes(pagina, ".article-body") %>% 
    html_text() %>% 
    str_replace_all("\r\n\r\n", "\n") %>% 
    str_replace_all("\u200B", "")
  return(texto)
}

dame_archivo <- function(url_doc, directorio_corpus){
#Crea el documento, lo nombra con su fecha y lo coloca en un directorio especificado  
  if (dir.exists(directorio_corpus) == FALSE){
    dir.create(directorio_corpus)
    }
  pagina <- read_html(url_doc)
  fecha <- dame_fecha(pagina)
  texto <- dame_texto(pagina)
  nombre_archivo = str_c(fecha, ".txt")
  archivo <- file(str_c(directorio_corpus, nombre_archivo, sep="/"), encoding= "utf8")
  writeLines(texto, archivo)
  on.exit(close(archivo))
  #gc()
}

```

Armar el corpus (incluye una pausa después de cada archivo descargado):

```{R}


for (direccion in url_conferencias[1]) {
  dame_archivo(direccion, "corpus_simple")
  Sys.sleep(10)
}

```

Expresiones regulares útiles:

```
#Solución simplona para capturar a los interlocutores.
^[A-Z][A-Z].*[A-Z](?=:)

#Remover los separadores e identificadores finales
---\n \n.*
```

Pruebas para extraer interlocutores (aún con fallos):

```{R}

dame_interlocutores <- function(doc) {
  
  interlocutores <- readLines(doc, encoding = "UTF-8") %>% 
    str_extract("^[A-Z][A-Z].*[A-Z](?=:)") %>% 
    unique()
  
  return(interlocutores)
}

"corpus_simple/2020-04-12.txt" %>% 
  dame_interlocutores()


```